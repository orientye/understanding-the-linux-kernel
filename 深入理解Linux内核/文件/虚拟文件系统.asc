:toc:
:toclevels: 4
:hardbreaks-option:

== 虚拟文件系统

=== 结构
==== 概览
https://en.wikipedia.org/wiki/Virtual_file_system
https://en.wikipedia.org/wiki/Virtual_file_system#/media/File:The_Linux_Storage_Stack_Diagram.svg

https://github.com/torvalds/linux/blob/master/include/linux/sched.h
[source,c]
----
struct task_struct {
    ......

	/* Filesystem information: */
	struct fs_struct		*fs;

	/* Open file information: */
	struct files_struct		*files;
    
    ......
};
----

struct fs_struct:
文件系统信息
https://github.com/torvalds/linux/blob/master/include/linux/fs_struct.h
[source,c]
----
struct fs_struct {
	int users;
	spinlock_t lock;
	seqcount_spinlock_t seq;
	int umask;
	int in_exec;
	struct path root, pwd;
} __randomize_layout;
----

struct files_struct:
已打开文件的信息
https://github.com/torvalds/linux/blob/master/include/linux/fdtable.h
[source,c]
----
/*
 * Open file table structure
 */
struct files_struct {
  /*
   * read mostly part
   */
	atomic_t count;
	bool resize_in_progress;
	wait_queue_head_t resize_wait;

	struct fdtable __rcu *fdt;
	struct fdtable fdtab;
  /*
   * written part on a separate cache line in SMP
   */
	spinlock_t file_lock ____cacheline_aligned_in_smp;
	unsigned int next_fd;
	unsigned long close_on_exec_init[1];
	unsigned long open_fds_init[1];
	unsigned long full_fds_bits_init[1];
	struct file __rcu * fd_array[NR_OPEN_DEFAULT];
};
----

==== inode
struct inode: https://github.com/torvalds/linux/blob/master/include/linux/fs.h
inode又称文件索引节点, 包含文件的基础信息以及数据块的指针, 但inode里不包含文件名
文件名在目录项里: struct ext4_dir_entry
https://github.com/torvalds/linux/blob/master/fs/ext4/ext4.h
目录也是一种文件, 是一种特殊的磁盘文件。这种文件的文件名就是目录名, 也有索引节点并且有数据部分, 不同的是其数据部分的内容只包括目录项。
对Ext4文件系统, 目录项就是ext4_dir_entry

=== 操作

=== 标准函数
