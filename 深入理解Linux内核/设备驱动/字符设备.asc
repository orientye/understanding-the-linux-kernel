:toc:
:toclevels: 5
:hardbreaks-option:

== 字符设备

=== 结构
[source,c]
.https://elixir.bootlin.com/linux/latest/source/include/linux/cdev.h
----
struct cdev {
	struct kobject kobj;
	struct module *owner;
	const struct file_operations *ops;
	struct list_head list;
	dev_t dev;
	unsigned int count;
} __randomize_layout;
----

=== 简单字符设备
先看一下简单字符设备，以空设备/dev/null为例:
[source,c]
.https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/major.h
----
#define MEM_MAJOR		1
----

[source,c]
.https://elixir.bootlin.com/linux/latest/source/drivers/char/mem.c
----
static ssize_t read_null(struct file *file, char __user *buf,
			 size_t count, loff_t *ppos)
{
	return 0;
}

static ssize_t write_null(struct file *file, const char __user *buf,
			  size_t count, loff_t *ppos)
{
	return count;
}
//...
static const struct file_operations null_fops = {
	.llseek		= null_lseek,
	.read		= read_null,
	.write		= write_null,
	.read_iter	= read_iter_null,
	.write_iter	= write_iter_null,
	.splice_write	= splice_write_null,
	.uring_cmd	= uring_cmd_null,
};
//...
static const struct memdev {
	const char *name;
	umode_t mode;
	const struct file_operations *fops;
	fmode_t fmode;
} devlist[] = {
#ifdef CONFIG_DEVMEM
	 [DEVMEM_MINOR] = { "mem", 0, &mem_fops, FMODE_UNSIGNED_OFFSET },
#endif
	 [3] = { "null", 0666, &null_fops, FMODE_NOWAIT },
#ifdef CONFIG_DEVPORT
	 [4] = { "port", 0, &port_fops, 0 },
#endif
	 [5] = { "zero", 0666, &zero_fops, FMODE_NOWAIT },
	 [7] = { "full", 0666, &full_fops, 0 },
	 [8] = { "random", 0666, &random_fops, FMODE_NOWAIT },
	 [9] = { "urandom", 0666, &urandom_fops, FMODE_NOWAIT },
#ifdef CONFIG_PRINTK
	[11] = { "kmsg", 0644, &kmsg_fops, 0 },
#endif
};
//...
static int __init chr_dev_init(void)
{
	int minor;

	if (register_chrdev(MEM_MAJOR, "mem", &memory_fops))
		printk("unable to get major %d for memory devs\n", MEM_MAJOR);

	mem_class = class_create(THIS_MODULE, "mem");
	if (IS_ERR(mem_class))
		return PTR_ERR(mem_class);

	mem_class->devnode = mem_devnode;
	for (minor = 1; minor < ARRAY_SIZE(devlist); minor++) {
		if (!devlist[minor].name)
			continue;

		/*
		 * Create /dev/port?
		 */
		if ((minor == DEVPORT_MINOR) && !arch_has_dev_port())
			continue;

		device_create(mem_class, NULL, MKDEV(MEM_MAJOR, minor),
			      NULL, devlist[minor].name);
	}

	return tty_init();
}
----

=== console
https://elixir.bootlin.com/linux/latest/source/drivers/video/console
https://elixir.bootlin.com/linux/latest/source/drivers/video/fbdev

https://elixir.bootlin.com/linux/latest/source/include/linux/console_struct.h

控制台输入:
https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/input-event-codes.h

https://elixir.bootlin.com/linux/latest/source/drivers/tty/vt/keyboard.c

控制台输出:

    printf进入write系统调用:
    helloworld-24714 [003] 531976.050326: funcgraph_entry:                   |  __x64_sys_write() {
    helloworld-24714 [003] 531976.050327: funcgraph_entry:                   |    ksys_write() {
    helloworld-24714 [003] 531976.050327: funcgraph_entry:                   |      vfs_write() {
    helloworld-24714 [003] 531976.050328: funcgraph_entry:                   |        new_sync_write() {
    helloworld-24714 [003] 531976.050329: funcgraph_entry:                   |          tty_write() {

    tty_write(): https://elixir.bootlin.com/linux/latest/source/drivers/tty/tty_io.c
        file_tty_write()
            n_tty_write()
                con_write(): https://elixir.bootlin.com/linux/latest/source/drivers/tty/vt/vt.c
                    do_con_write()

    helloworld-24799 [002] 532659.588813: funcgraph_entry:                   |  tty_write() {
    helloworld-24799 [002] 532659.588815: funcgraph_entry:                   |    file_tty_write.constprop.0() {
    helloworld-24799 [002] 532659.588817: funcgraph_entry:                   |      n_tty_write() {
    helloworld-24799 [002] 532659.588820: funcgraph_entry:                   |          tty_write_room() {
    helloworld-24799 [002] 532659.588820: funcgraph_entry:        0.063 us   |            con_write_room();
    helloworld-24799 [002] 532659.588820: funcgraph_entry:                   |          con_write() {
    helloworld-24799 [002] 532659.588821: funcgraph_entry:                   |            do_con_write() {
    helloworld-24799 [002] 532659.588851: funcgraph_entry:                   |              vc_con_write_normal() {
    helloworld-24799 [002] 532659.588852: funcgraph_entry:                   |              vc_con_write_normal() {
    helloworld-24799 [002] 532659.588853: funcgraph_entry:                   |              vc_con_write_normal() {
    helloworld-24799 [002] 532659.588854: funcgraph_entry:                   |              vc_con_write_normal() {
    helloworld-24799 [002] 532659.588856: funcgraph_entry:                   |              vc_con_write_normal() {
    helloworld-24799 [002] 532659.588857: funcgraph_entry:                   |              vc_con_write_normal() {

pty:
https://elixir.bootlin.com/linux/latest/source/arch/um/drivers/pty.c

v0.12:
https://elixir.bootlin.com/linux/0.12/source/kernel/chr_drv/console.c

参考: https://www.cnblogs.com/tsecer/p/10485870.html
